USE master;
GO
ALTER DATABASE QLCT SET SINGLE_USER WITH ROLLBACK IMMEDIATE;
GO
DROP DATABASE QLCT;
GO

create database QLCT
go
use QLCT
go
set dateformat dmy
go

-- Bảng KHACHHANG
CREATE TABLE KHACHHANG (
    makh INT IDENTITY(1,1) PRIMARY KEY,
    tenkh NVARCHAR(100) NOT NULL,
    email NVARCHAR(150) NOT NULL UNIQUE,
    matkhau NVARCHAR(255) NOT NULL,
    hinhanh NVARCHAR(255) NULL,
    quyen NVARCHAR(20) NOT NULL DEFAULT 'user',
    created_at DATETIME2 DEFAULT GETDATE(),
    updated_at DATETIME2 DEFAULT GETDATE()
);
GO

-- Bảng DMCHITIEU
CREATE TABLE DMCHITIEU (
    machitieu INT IDENTITY(1,1) PRIMARY KEY,
    makh INT NOT NULL,
    tendanhmuc NVARCHAR(100) NOT NULL,
    loai NVARCHAR(10) NOT NULL CHECK (loai IN ('income','expense')),
    created_at DATETIME2 DEFAULT GETDATE(),
    updated_at DATETIME2 DEFAULT GETDATE(),
    CONSTRAINT FK_DMCHITIEU_KHACHHANG FOREIGN KEY (makh)
        REFERENCES KHACHHANG(makh) ON DELETE NO ACTION ON UPDATE NO ACTION
);
GO

-- Bảng DSCHITIEU
CREATE TABLE DSCHITIEU (
    maloaichitieu INT IDENTITY(1,1) PRIMARY KEY,
    makh INT NOT NULL,
    machitieu INT NOT NULL,
    ngaychitieu DATE NOT NULL,
    noidung NVARCHAR(255) NOT NULL,
    loai NVARCHAR(10) NOT NULL CHECK (loai IN ('income','expense')),
    sotien DECIMAL(18,2) NOT NULL,
    created_at DATETIME2 DEFAULT GETDATE(),
    updated_at DATETIME2 DEFAULT GETDATE(),
    CONSTRAINT FK_DSCHITIEU_KHACHHANG FOREIGN KEY (makh)
        REFERENCES KHACHHANG(makh) ON DELETE NO ACTION ON UPDATE NO ACTION,
    CONSTRAINT FK_DSCHITIEU_DMCHITIEU FOREIGN KEY (machitieu)
        REFERENCES DMCHITIEU(machitieu) ON DELETE NO ACTION ON UPDATE NO ACTION
);
GO

-- Bảng DSTHUNHAP
CREATE TABLE DSTHUNHAP (
    mathunhap INT IDENTITY(1,1) PRIMARY KEY,
    makh INT NOT NULL,
    machitieu INT NOT NULL,
    ngaythunhap DATE NOT NULL,
    noidung NVARCHAR(255) NOT NULL,
    loai NVARCHAR(10) NOT NULL DEFAULT 'income' CHECK (loai IN ('income','expense')),
    sotien DECIMAL(18,2) NOT NULL,
    created_at DATETIME2 DEFAULT GETDATE(),
    updated_at DATETIME2 DEFAULT GETDATE(),
    CONSTRAINT FK_DSTHUNHAP_KHACHHANG FOREIGN KEY (makh)
        REFERENCES KHACHHANG(makh) ON DELETE NO ACTION ON UPDATE NO ACTION,
    CONSTRAINT FK_DSTHUNHAP_DMCHITIEU FOREIGN KEY (machitieu)
        REFERENCES DMCHITIEU(machitieu) ON DELETE NO ACTION ON UPDATE NO ACTION
);
GO

-- Bảng GIAODICH
CREATE TABLE GIAODICH (
    magd INT IDENTITY(1,1) PRIMARY KEY,
    makh INT NOT NULL,
    machitieu INT NOT NULL,
    sotien DECIMAL(18,2) NOT NULL,
    loai NVARCHAR(10) NOT NULL CHECK (loai IN ('income','expense')),
    ngaygiaodich DATE NOT NULL,
    ghichu NVARCHAR(255) NULL,
    anhhoadon NVARCHAR(255) NULL,
    created_at DATETIME2 DEFAULT GETDATE(),
    updated_at DATETIME2 DEFAULT GETDATE(),
    CONSTRAINT FK_GIAODICH_KHACHHANG FOREIGN KEY (makh)
        REFERENCES KHACHHANG(makh) ON DELETE NO ACTION ON UPDATE NO ACTION,
    CONSTRAINT FK_GIAODICH_DMCHITIEU FOREIGN KEY (machitieu)
        REFERENCES DMCHITIEU(machitieu) ON DELETE NO ACTION ON UPDATE NO ACTION
);
GO

-- Bảng NGANSACH
CREATE TABLE NGANSACH (
    mangansach INT IDENTITY(1,1) PRIMARY KEY,
    makh INT NOT NULL,
    machitieu INT NOT NULL,
    ngay DATE NOT NULL,
    ngansach DECIMAL(18,2) NOT NULL,
    dachi DECIMAL(18,2) NOT NULL DEFAULT 0,
    chenhlech AS (ngansach - dachi) PERSISTED,
    trangthai NVARCHAR(20) NOT NULL DEFAULT 'on_budget'
        CHECK (trangthai IN ('under_budget','on_budget','over_budget')),
    created_at DATETIME2 DEFAULT GETDATE(),
    updated_at DATETIME2 DEFAULT GETDATE(),
    CONSTRAINT FK_NGANSACH_KHACHHANG FOREIGN KEY (makh)
        REFERENCES KHACHHANG(makh) ON DELETE NO ACTION ON UPDATE NO ACTION,
    CONSTRAINT FK_NGANSACH_DMCHITIEU FOREIGN KEY (machitieu)
        REFERENCES DMCHITIEU(machitieu) ON DELETE NO ACTION ON UPDATE NO ACTION
);
GO

-- Bảng BANGNO
CREATE TABLE BANGNO (
    mabangno INT IDENTITY(1,1) PRIMARY KEY,
    makh INT NOT NULL,
    sotienno DECIMAL(18,2) NOT NULL,
    loai NVARCHAR(10) NOT NULL CHECK (loai IN ('lend','borrow')),
    nguoilienquan NVARCHAR(100) NOT NULL,
    ngaydaohan DATE NOT NULL,
    trangthai NVARCHAR(10) NOT NULL CHECK (trangthai IN ('pending','paid')),
    created_at DATETIME2 DEFAULT GETDATE(),
    updated_at DATETIME2 DEFAULT GETDATE(),
    CONSTRAINT FK_BANGNO_KHACHHANG FOREIGN KEY (makh)
        REFERENCES KHACHHANG(makh) ON DELETE NO ACTION ON UPDATE NO ACTION
);
GO

-- Bảng TIETKIEM
CREATE TABLE TIETKIEM (
    matk INT IDENTITY(1,1) PRIMARY KEY,
    makh INT NOT NULL,
    muctieu NVARCHAR(150) NOT NULL,
    sotiencandat DECIMAL(18,2) NOT NULL,
    sotiendatietkiem DECIMAL(18,2) NOT NULL DEFAULT 0,
    hanmuctieu DATE NOT NULL,
    created_at DATETIME2 DEFAULT GETDATE(),
    updated_at DATETIME2 DEFAULT GETDATE(),
    CONSTRAINT FK_TIETKIEM_KHACHHANG FOREIGN KEY (makh)
        REFERENCES KHACHHANG(makh) ON DELETE NO ACTION ON UPDATE NO ACTION
);
GO

-- Bảng THONGBAO
CREATE TABLE THONGBAO (
    matb INT IDENTITY(1,1) PRIMARY KEY,
    makh INT NOT NULL,
    noidung NVARCHAR(255) NOT NULL,
    loai NVARCHAR(10) NOT NULL CHECK (loai IN ('warning','reminder','info')),
    trangthai BIT NOT NULL DEFAULT 0,
    created_at DATETIME2 DEFAULT GETDATE(),
    CONSTRAINT FK_THONGBAO_KHACHHANG FOREIGN KEY (makh)
        REFERENCES KHACHHANG(makh) ON DELETE NO ACTION ON UPDATE NO ACTION
);
GO

-- Bảng BAOCAO
CREATE TABLE BAOCAO (
    mabaocao INT IDENTITY(1,1) PRIMARY KEY,
    makh INT NOT NULL,
    thang INT NOT NULL CHECK (thang BETWEEN 1 AND 12),
    nam INT NOT NULL,
    tongthunhap DECIMAL(18,2) NOT NULL DEFAULT 0,
    tongchitieu DECIMAL(18,2) NOT NULL DEFAULT 0,
    sodu AS (tongthunhap - tongchitieu) PERSISTED,
    created_at DATETIME2 DEFAULT GETDATE(),
    updated_at DATETIME2 DEFAULT GETDATE(),
    CONSTRAINT FK_BAOCAO_KHACHHANG FOREIGN KEY (makh)
        REFERENCES KHACHHANG(makh) ON DELETE NO ACTION ON UPDATE NO ACTION,
    CONSTRAINT UQ_BAOCAO UNIQUE (makh, thang, nam)
);
GO
-- BẢNG TIMKIEM
CREATE TABLE TIMKIEM (
  matimkiem INT IDENTITY(1,1) PRIMARY KEY,
  magd int,
  makh int,
  tenkhoanchi NVARCHAR(255) NOT NULL,
  mota NVARCHAR(MAX) NOT NULL,
  sotien DECIMAL(18,2) NOT NULL,
  danhmuc NVARCHAR(255) NOT NULL,
  tukhoa NVARCHAR(255) NOT NULL,
  ngaychi DATETIME2 NOT NULL,
  taoluc DATETIME2 NOT NULL,
  capnhatluc DATETIME2 NOT NULL,
   CONSTRAINT FK_TIMKIEM_GIAODICH FOREIGN KEY (magd) REFERENCES GIAODICH (magd) ON DELETE CASCADE ON UPDATE CASCADE,
   CONSTRAINT FK_TIMKIEM_KHACHHANG FOREIGN KEY (makh) REFERENCES KHACHHANG (makh) ON DELETE CASCADE ON UPDATE CASCADE
);
GO

CREATE TABLE DANHMUC (
  madanhmuc INT PRIMARY KEY, -- KHÔNG có IDENTITY
  tendanhmuc NVARCHAR(100) NOT NULL,
  matk INT,
  CONSTRAINT FK_DANHMUC_TIMKIEM FOREIGN KEY (matk)
    REFERENCES TIMKIEM (matimkiem)
    ON DELETE CASCADE ON UPDATE CASCADE
);



-- BẢNG KHOANCHI
CREATE TABLE KHOANCHI (
  machi INT IDENTITY(1,1) PRIMARY KEY,
  tenkhoanchi NVARCHAR(255) NOT NULL,
  sotien DECIMAL(12,2) NOT NULL,
  madanhmuc int,
  ngaybatdau DATETIME2 NOT NULL,
  lapphieu NVARCHAR(20) NOT NULL DEFAULT 'Không lặp lại'
    CHECK (lapphieu IN (N'Hàng ngày', N'Hàng tháng', N'Hàng năm', N'Không lặp lại')),
	CONSTRAINT FK_KHOANCHI_DANHMUC FOREIGN KEY (madanhmuc) REFERENCES DANHMUC (madanhmuc) ON DELETE CASCADE ON UPDATE CASCADE
);
GO

-- BẢNG LAPNGANSACHTHEOTHANG
CREATE TABLE LAPNGANSACHTHEOTHANG (
  mangansach INT IDENTITY(1,1) PRIMARY KEY,
  makh INT,
  thang DATETIME2 NOT NULL,
  nam DATETIME2 NOT NULL,
  tongngansach DECIMAL(18,2) NOT NULL,
  CONSTRAINT FK_NS_THANG_KHACHHANG FOREIGN KEY (makh) REFERENCES KHACHHANG (makh) ON DELETE CASCADE ON UPDATE CASCADE
);
GO
-- BẢNG CHITIETNGANSACH
CREATE TABLE CHITIETNGANSACH (
  machitiet INT IDENTITY(1,1) PRIMARY KEY,
  mangansach INT,
  machitieu INT NOT NULL,
  sotienphanbo DECIMAL(18,2) NOT NULL,
  CONSTRAINT FK_CTNS_DMCHITIEU FOREIGN KEY (machitieu) REFERENCES DMCHITIEU (machitieu) ON DELETE CASCADE ON UPDATE CASCADE,
  CONSTRAINT FK_CTNS_NGANSACH FOREIGN KEY (mangansach) REFERENCES LAPNGANSACHTHEOTHANG (mangansach) ON DELETE CASCADE ON UPDATE CASCADE
);
GO

-- BẢNG LICHTHUCHI
CREATE TABLE LICHTHUCHI (
  mathuchi INT IDENTITY(1,1) PRIMARY KEY,
  ngay DATETIME2 NOT NULL,
  loai NVARCHAR(10) NOT NULL CHECK (loai IN ('thu','chi')),
  sotien DECIMAL(18,2) NOT NULL,
  ghichu varchar(255) DEFAULT NULL,
  makh int NOT NULL,
  CONSTRAINT FK_LICHTHUCHI_KHACHHANG FOREIGN KEY (makh) REFERENCES KHACHHANG (makh) ON DELETE CASCADE ON UPDATE CASCADE
);
GO

-- BẢNG SUAKHOANTHUNHAP
CREATE TABLE SUAKHOANTHUNHAP (
  mathuanhap INT IDENTITY(1,1) PRIMARY KEY,
  makh int,
  tenkhoanthu NVARCHAR(255) NOT NULL,
  sotien DECIMAL(18,2) NOT NULL,
  ngaynhan DATETIME2 NOT NULL,
  danhmuc NVARCHAR(255) NOT NULL,
  mota NVARCHAR(MAX) NOT NULL,
  CONSTRAINT FK_SUAKHOANTHUNHAP_KHACHHANG FOREIGN KEY (makh) REFERENCES KHACHHANG (makh) ON DELETE CASCADE ON UPDATE CASCADE
);
GO





